{{#models}}
{{#model}}
#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include "{{classname}}.h"


{{#vars}}
{{#isEnum}}
{{^isModel}}
{{#isPrimitiveType}}
char* {{datatypeWithEnum}}_ToString({{baseName}}_e {{baseName}}){
    char *{{baseName}}Array[] =  { {{#allowableValues}}{{#enumVars}}"{{{value}}}"{{^-last}},{{/-last}}{{/enumVars}}{{/allowableValues}} };
    return {{baseName}}Array[{{baseName}}];

}

{{baseName}}_e {{datatypeWithEnum}}_FromString(char* {{baseName}}){
    int stringToReturn = 0;
    char *{{baseName}}Array[] =  { {{#allowableValues}}{{#enumVars}}"{{{value}}}"{{^-last}},{{/-last}}{{/enumVars}}{{/allowableValues}} };
    size_t sizeofArray = sizeof({{baseName}}Array) / sizeof({{baseName}}Array[0]);
    while(stringToReturn < sizeofArray) {
        if(strcmp({{baseName}}, {{baseName}}Array[stringToReturn]) == 0) {
            return stringToReturn;
        }
        stringToReturn++;
    }
    return 0;
}

cJSON *{{baseName}}_convertToJSON({{baseName}}_e {{baseName}}) {
	cJSON *item = cJSON_CreateObject();
    {{#isString}}
    if(cJSON_AddStringToObject(item, "{{{baseName}}}", {{{datatypeWithEnum}}}_ToString({{{baseName}}})) == NULL) {
    goto fail;
    }
    {{/isString}}
    {{^isString}}
    if(cJSON_AddNumberToObject(item, "{{{baseName}}}", {{{baseName}}}) == NULL) {
    goto fail;
    }
    {{/isString}}
    return item;
fail:
	cJSON_Delete(item);
	return NULL;
}

{{baseName}}_e {{baseName}}_parseFromJSON(char *jsonString){

    {{baseName}}_e *{{baseName}} = NULL;
    cJSON *{{classname}}JSON = cJSON_Parse(jsonString);
    if({{classname}}JSON == NULL){
        const char *error_ptr = cJSON_GetErrorPtr();
        if (error_ptr != NULL) {
            fprintf(stderr, "Error Before: %s\n", error_ptr);
            goto end;
        }
    }

    {{#isNumeric}}
    cJSON *{{{baseName}}}Var = cJSON_GetObjectItemCaseSensitive({{baseName}}JSON, "{{{baseName}}}");
    if(!cJSON_IsNumber({{{baseName}}}Var))
    {
    goto end;
    }
    {{/isNumeric}}
    {{#isEnum}}
    {{#isString}}
    {{{datatypeWithEnum}}}_e {{baseName}}Variable;
    cJSON *{{{baseName}}}Var = cJSON_GetObjectItemCaseSensitive({{classname}}JSON, "{{{baseName}}}");
    if(!cJSON_IsString({{{baseName}}}Var) || ({{{baseName}}}Var->valuestring == NULL)){
    goto end;
    }

    {{baseName}}Variable = {{datatypeWithEnum}}_FromString({{{baseName}}}Var->valuestring);
    {{/isString}}
    {{/isEnum}}

 cJSON_Delete({{baseName}}JSON);
    return {{baseName}}Variable;
end:
    cJSON_Delete({{baseName}}JSON);
    return 0; // need to fix this

}
{{/isPrimitiveType}}
{{/isModel}}
{{/isEnum}}
{{/vars}}
{{^isEnum}}
{{classname}}_t *{{classname}}_create(
    {{#vars}}
    {{^isContainer}}
    {{^isPrimitiveType}}
    {{datatype}}_t *{{baseName}}{{#hasMore}},{{/hasMore}}
    {{/isPrimitiveType}}
    {{#isPrimitiveType}}
    {{#isNumeric}}
    {{datatype}} {{baseName}}{{#hasMore}},{{/hasMore}}
    {{/isNumeric}}
    {{#isBoolean}}
    bool {{baseName}}{{#hasMore}},{{/hasMore}}
    {{/isBoolean}}
    {{#isEnum}}
    {{#isString}}
    {{datatypeWithEnum}}_e {{baseName}}{{#hasMore}},{{/hasMore}}
    {{/isString}}
    {{/isEnum}}
    {{^isEnum}}
    {{#isString}}
    {{datatype}} *{{baseName}}{{#hasMore}},{{/hasMore}}
    {{/isString}}
    {{/isEnum}}
    {{#isByteArray}}
    {{datatype}} {{baseName}}{{#hasMore}},{{/hasMore}}
    {{/isByteArray}}
    {{#isBinary}}
    {{datatype}} {{baseName}}{{#hasMore}},{{/hasMore}}
    {{/isBinary}}
    {{#isDate}}
    {{datatype}} *{{baseName}}{{#hasMore}},{{/hasMore}}
    {{/isDate}}
    {{#isDateTime}}
    {{datatype}} *{{baseName}}{{#hasMore}},{{/hasMore}}
    {{/isDateTime}}
    {{/isPrimitiveType}}
    {{/isContainer}}
    {{#isContainer}}
    {{#isListContainer}}
    {{#isPrimitiveType}}
    {{datatype}}_t *{{baseName}}{{#hasMore}},{{/hasMore}}
    {{/isPrimitiveType}}
    {{^isPrimitiveType}}
    {{datatype}}_t *{{baseName}}{{#hasMore}},{{/hasMore}}
    {{/isPrimitiveType}}
    {{/isListContainer}}
    {{#isMapContainer}}
    {{datatype}} {{baseName}}{{#hasMore}},{{/hasMore}}
    {{/isMapContainer}}
    {{/isContainer}}
    {{/vars}}
    ) {
	{{classname}}_t *{{classname}} = malloc(sizeof({{classname}}_t));
	{{#vars}}
	{{classname}}->{{{baseName}}} = {{{baseName}}};
	{{/vars}}

	return {{classname}};
}


void {{classname}}_free({{classname}}_t *{{classname}}) {
    listEntry_t *listEntry;
	{{#vars}}
	{{^isContainer}}
	{{^isPrimitiveType}}
	{{{complexType}}}{{#isFreeFormObject}}object{{/isFreeFormObject}}_free({{{classname}}}->{{{baseName}}});
	{{/isPrimitiveType}}
	{{#isPrimitiveType}}
    {{^isEnum}}
    {{#isString}}
    free({{{classname}}}->{{{baseName}}});
    {{/isString}}
    {{/isEnum}}
    {{#isBinary}}
    free({{{classname}}}->{{{baseName}}}.data);
    {{/isBinary}}
    {{#isDate}}
    free({{{classname}}}->{{{baseName}}});
    {{/isDate}}
    {{#isDateTime}}
    free({{{classname}}}->{{{baseName}}});
    {{/isDateTime}}
	{{/isPrimitiveType}}
	{{/isContainer}}
	{{#isContainer}}
	{{#isListContainer}}
	{{#isPrimitiveType}}
	list_ForEach(listEntry, {{classname}}->{{baseName}}) {
		free(listEntry->data);
	}
	list_free({{classname}}->{{baseName}});
	{{/isPrimitiveType}}
	{{^isPrimitiveType}}
	{{^isEnum}}
    list_ForEach(listEntry, {{classname}}->{{baseName}}) {
		{{complexType}}_free(listEntry->data);
	}
    {{/isEnum}}
	list_free({{classname}}->{{baseName}});
	{{/isPrimitiveType}}
	{{/isListContainer}}
	{{#isMapContainer}}
	// TODO map/hash not supported at the moment
	{{/isMapContainer}}
	{{/isContainer}}
	{{/vars}}

	free({{classname}});
}

cJSON *{{classname}}_convertToJSON({{classname}}_t *{{classname}}) {
	cJSON *item = cJSON_CreateObject();
	{{#vars}}
	// {{{classname}}}->{{{baseName}}}
	{{^isContainer}}
	{{#isPrimitiveType}}
    {{#isNumeric}}
    if(cJSON_AddNumberToObject(item, "{{{baseName}}}", {{{classname}}}->{{{baseName}}}) == NULL) {
    goto fail; //Numeric
    }
    {{/isNumeric}}
    {{#isBoolean}}
    if(cJSON_AddBoolToObject(item, "{{{baseName}}}", {{{classname}}}->{{{baseName}}}) == NULL) {
    goto fail; //Bool
    }
    {{/isBoolean}}
    {{#isEnum}}
    {{#isString}}
    if(cJSON_AddStringToObject(item, "{{{baseName}}}", {{^isModel}}{{{datatypeWithEnum}}}_ToString{{/isModel}}({{{classname}}}->{{{baseName}}})) == NULL)
    {
    goto fail; //Enum
    }
    {{/isString}}
    {{/isEnum}}
    {{^isEnum}}
    {{#isString}}
    if(cJSON_AddStringToObject(item, "{{{baseName}}}", {{{classname}}}->{{{baseName}}}) == NULL) {
    goto fail; //String
    }
    {{/isString}}
    {{/isEnum}}
    {{#isByteArray}}
    if(cJSON_AddNumberToObject(item, "{{{baseName}}}", {{{classname}}}->{{{baseName}}}) == NULL) {
    goto fail; //Byte
    }
    {{/isByteArray}}
    {{#isBinary}}
    char* encoded_str = base64encode(mem_pool, {{{classname}}}->{{{baseName}}}.data,{{{classname}}}->{{{baseName}}}.len);
    if(cJSON_AddStringToObject(item, "{{{baseName}}}", encoded_str) == NULL) {
    goto fail; //Binary
    }
    {{/isBinary}}
    {{#isDate}}
    if(cJSON_AddStringToObject(item, "{{{baseName}}}", {{{classname}}}->{{{baseName}}}) == NULL) {
    goto fail; //Date
    }
    {{/isDate}}
    {{#isDateTime}}
    if(cJSON_AddStringToObject(item, "{{{baseName}}}", {{{classname}}}->{{{baseName}}}) == NULL) {
    goto fail; //Date-Time
    }
    {{/isDateTime}}
	{{/isPrimitiveType}}
	{{^isPrimitiveType}}
	cJSON *{{{baseName}}} = {{complexType}}{{#isFreeFormObject}}object{{/isFreeFormObject}}_convertToJSON({{{classname}}}->{{{baseName}}});
	if({{{baseName}}} == NULL) {
		goto fail; //nonprimitive
	}
	cJSON_AddItemToObject(item, "{{{baseName}}}", {{{baseName}}});
	if(item->child == NULL) {
		goto fail;
	}
	{{/isPrimitiveType}}
	{{/isContainer}}
	{{#isContainer}}
	{{#isListContainer}}
	{{#isPrimitiveType}}
	cJSON *{{{name}}} = cJSON_AddArrayToObject(item, "{{{baseName}}}");
	if({{{name}}} == NULL) {
		goto fail; //primitive container
	}

	listEntry_t *{{{name}}}ListEntry;
    list_ForEach({{{name}}}ListEntry, {{{classname}}}->{{{baseName}}}) {
        {{#items}}
        {{#isString}}
        if(cJSON_AddStringToObject({{{baseName}}}, "", (char*){{{baseName}}}ListEntry->data) == NULL)
        {
            goto fail;
        }
        {{/isString}}
        {{^isString}}
        if(cJSON_AddNumberToObject({{{baseName}}}, "", *(double *){{{baseName}}}ListEntry->data) == NULL)
        {
            goto fail;
        }
        {{/isString}}
        {{/items}}
    }
	{{/isPrimitiveType}}
	{{^isPrimitiveType}}
    cJSON *{{{baseName}}} = cJSON_AddArrayToObject(item, "{{{baseName}}}");
	if({{{baseName}}} == NULL) {
		goto fail; //nonprimitive container
	}

	listEntry_t *{{{baseName}}}ListEntry;
	list_ForEach({{{baseName}}}ListEntry, {{classname}}->{{{baseName}}}) {
		cJSON *item = {{complexType}}_convertToJSON({{#isEnum}}{{#items}}({{datatypeWithEnum}}_e){{/items}}{{/isEnum}}{{{baseName}}}ListEntry->data);
		if(item == NULL) {
			goto fail;
		}
		cJSON_AddItemToArray({{{baseName}}}, item);
	}
	{{/isPrimitiveType}}
	{{/isListContainer}}
	{{#isMapContainer}}
	// map Container
	cJSON *{{{baseName}}} = cJSON_AddObjectToObject(item, "{{{baseName}}}");
	if({{{baseName}}} == NULL) {
		goto fail; //primitive map container
	}
    cJSON *localMapObject = cJSON_CreateObject(); //Memory free to be implemented in user code
	listEntry_t *{{{baseName}}}ListEntry;
    list_ForEach({{{baseName}}}ListEntry, {{{classname}}}->{{{baseName}}}) {
        keyValuePair_t *localKeyValue = (keyValuePair_t*){{{baseName}}}ListEntry->data;
        {{#items}}
        {{#isString}}
        if(cJSON_AddStringToObject(localMapObject, localKeyValue->key, (char*)localKeyValue->value) == NULL)
        {
            goto fail;
        }
        {{/isString}}
        {{^isString}}
        if(cJSON_AddNumberToObject(localMapObject, localKeyValue->key, *(double *)localKeyValue->value) == NULL)
        {
            goto fail;
        }
        {{/isString}}
        {{/items}}
        cJSON_AddItemToObject({{{baseName}}},"", localMapObject);
    }
	{{/isMapContainer}}
	{{/isContainer}}

    {{/vars}}
	return item;
fail:
	cJSON_Delete(item);
	return NULL;
}

{{classname}}_t *{{classname}}_parseFromJSON(cJSON *{{classname}}JSON){

    {{classname}}_t *{{classname}} = NULL;

    {{#vars}}
    // {{{classname}}}->{{{baseName}}}
    {{^isContainer}}
    {{#isPrimitiveType}}
    {{#isNumeric}}
    cJSON *{{{baseName}}} = cJSON_GetObjectItemCaseSensitive({{classname}}JSON, "{{{baseName}}}");
    if(!cJSON_IsNumber({{{baseName}}}))
    {
    goto end; //Numeric
    }
    {{/isNumeric}}
    {{#isBoolean}}
    cJSON *{{{baseName}}} = cJSON_GetObjectItemCaseSensitive({{classname}}JSON, "{{{baseName}}}");
    if(!cJSON_IsBool({{{baseName}}}))
    {
    goto end; //Bool
    }
    {{/isBoolean}}
    {{#isEnum}}
    {{#isString}}
    {{{datatypeWithEnum}}}_e {{baseName}}Variable;
    cJSON *{{{baseName}}} = cJSON_GetObjectItemCaseSensitive({{classname}}JSON, "{{{baseName}}}");
    if(!cJSON_IsString({{{baseName}}}))
    {
    goto end; //Enum
    }
    {{baseName}}Variable = {{^isModel}}{{datatypeWithEnum}}_FromString{{/isModel}}({{{baseName}}}->valuestring);
    {{/isString}}
    {{/isEnum}}
    {{^isEnum}}
    {{#isString}}
    cJSON *{{{baseName}}} = cJSON_GetObjectItemCaseSensitive({{classname}}JSON, "{{{baseName}}}");
    if(!cJSON_IsString({{{baseName}}}))
    {
    goto end; //String
    }
    {{/isString}}
    {{/isEnum}}
    {{#isByteArray}}
    if(cJSON_AddNumberToObject(item, "{{{baseName}}}", {{{classname}}}->{{{baseName}}}) == NULL) {
    goto fail; //Byte
    }
    {{/isByteArray}}
    {{#isBinary}}
    cJSON *{{{baseName}}} = cJSON_GetObjectItemCaseSensitive({{classname}}JSON, "{{{baseName}}}");
    if(!cJSON_IsString({{{baseName}}}))
    {
    goto end; //Binary
    }
    char* decoded_str = base64decode(mem_pool, {{{baseName}}}->valuestring, strlen({{{baseName}}}->valuestring));
    {{/isBinary}}
    {{#isDate}}
    cJSON *{{{baseName}}} = cJSON_GetObjectItemCaseSensitive({{classname}}JSON, "{{{baseName}}}");
    if(!cJSON_IsString({{{baseName}}}))
    {
    goto end; //Date
    }
    {{/isDate}}
    {{#isDateTime}}
    cJSON *{{{baseName}}} = cJSON_GetObjectItemCaseSensitive({{classname}}JSON, "{{{baseName}}}");
    if(!cJSON_IsString({{{baseName}}}))
    {
    goto end; //DateTime
    }
    {{/isDateTime}}
    {{/isPrimitiveType}}
    {{^isPrimitiveType}}
    {{^isFreeFormObject}}{{complexType}}{{/isFreeFormObject}}{{#isFreeFormObject}}object{{/isFreeFormObject}}_t *{{baseName}} = NULL;
    cJSON *{{baseName}}JSON = cJSON_GetObjectItemCaseSensitive({{classname}}JSON, "{{baseName}}");
    if({{baseName}}JSON != NULL){
    {{{baseName}}} = {{complexType}}{{#isFreeFormObject}}object{{/isFreeFormObject}}_parseFromJSON({{{baseName}}}JSON); //nonprimitive
    }
    {{/isPrimitiveType}}
    {{/isContainer}}
    {{#isContainer}}
    {{#isListContainer}}
    {{#isPrimitiveType}}
    cJSON *{{{name}}};
    cJSON *{{{baseName}}}JSON = cJSON_GetObjectItemCaseSensitive({{classname}}JSON, "{{{baseName}}}");
    if(!cJSON_IsArray({{{baseName}}}JSON)) {
        goto end;//primitive container
    }
    list_t *{{{name}}}List = list_create();

    cJSON_ArrayForEach({{{name}}}, {{{baseName}}}JSON)
    {
        {{#items}}
        {{#isString}}
        if(!cJSON_IsString({{{baseName}}}))
        {
            goto end;
        }
        list_addElement({{{baseName}}}List , strdup({{{baseName}}}->valuestring));
        {{/isString}}
        {{^isString}}
        if(!cJSON_IsNumber({{{baseName}}}))
        {
            goto end;
        }
        list_addElement({{{baseName}}}List , &{{{baseName}}}->valuedouble);
        {{/isString}}
        {{/items}}

    }
    {{/isPrimitiveType}}
    {{^isPrimitiveType}}
    cJSON *{{{baseName}}};
    cJSON *{{{baseName}}}JSON = cJSON_GetObjectItemCaseSensitive({{classname}}JSON,"{{{baseName}}}");
    if(!cJSON_IsArray({{{baseName}}}JSON)){
        goto end; //nonprimitive container
    }

    list_t *{{{baseName}}}List = list_create();

    cJSON_ArrayForEach({{{baseName}}},{{{baseName}}}JSON )
    {
        if(!cJSON_IsObject({{{baseName}}})){
            goto end;
        }
        {{#isEnum}}{{#items}}{{datatypeWithEnum}}_e {{/items}}{{/isEnum}}{{^isEnum}}{{complexType}}_t *{{/isEnum}}{{{baseName}}}Item = {{complexType}}_parseFromJSON({{{baseName}}});

        list_addElement({{{baseName}}}List, {{#isEnum}}{{#items}}(void *){{/items}}{{/isEnum}}{{{baseName}}}Item);
        free(JSONData);
    }
    {{/isPrimitiveType}}
    {{/isListContainer}}
    {{#isMapContainer}}
    // map
    cJSON *{{{complexType}}};
    cJSON *{{{baseName}}}JSON = cJSON_GetObjectItemCaseSensitive({{classname}}JSON, "{{{baseName}}}");
    if(!cJSON_IsObject({{{baseName}}}JSON)) {
        goto end;//primitive map container
    }
    list_t *{{{complexType}}}List = list_create();
    keyValuePair_t *localMapKeyPair;
    cJSON_ArrayForEach({{{complexType}}}, {{{baseName}}}JSON)
    {
        {{#items}}
        {{#isString}}
        if(!cJSON_IsString({{{complexType}}}))
        {
            goto end;
        }
        localMapKeyPair = keyValuePair_create(strdup({{{complexType}}}->string),strdup({{{complexType}}}->valuestring))
        list_addElement({{{complexType}}}List , localMapKeyPair);
        {{/isString}}
        {{^isString}}
        if(!cJSON_IsNumber({{{complexType}}}))
        {
            goto end;
        }
        localMapKeyPair = keyValuePair_create(strdup({{{complexType}}}->string),&{{{complexType}}}->valuedouble );
        list_addElement({{{complexType}}}List , localMapKeyPair);
        {{/isString}}
        {{/items}}

    }
    {{/isMapContainer}}
    {{/isContainer}}

    {{/vars}}

    {{classname}} = {{classname}}_create (
        {{#vars}}
        {{^isContainer}}
        {{^isPrimitiveType}}
        {{{baseName}}}{{#hasMore}},{{/hasMore}}
        {{/isPrimitiveType}}
        {{#isPrimitiveType}}
        {{#isNumeric}}
        {{{baseName}}}->valuedouble{{#hasMore}},{{/hasMore}}
        {{/isNumeric}}
        {{#isBoolean}}
        {{{baseName}}}->valueint{{#hasMore}},{{/hasMore}}
        {{/isBoolean}}
        {{#isEnum}}
        {{#isString}}
        {{baseName}}Variable{{#hasMore}},{{/hasMore}}
        {{/isString}}
        {{/isEnum}}
        {{^isEnum}}
        {{#isString}}
        strdup({{{baseName}}}->valuestring){{#hasMore}},{{/hasMore}}
        {{/isString}}
        {{/isEnum}}
        {{#isByteArray}}
        {{{baseName}}}->valueint{{#hasMore}},{{/hasMore}}
        {{/isByteArray}}
        {{#isBinary}}
        decoded_str{{#hasMore}},{{/hasMore}}
        {{/isBinary}}
        {{#isDate}}
        strdup({{{baseName}}}->valuestring){{#hasMore}},{{/hasMore}}
        {{/isDate}}
        {{#isDateTime}}
        strdup({{{baseName}}}->valuestring){{#hasMore}},{{/hasMore}}
        {{/isDateTime}}
        {{/isPrimitiveType}}
        {{/isContainer}}
        {{#isContainer}}
        {{#isListContainer}}
        {{#isPrimitiveType}}
        {{{name}}}List{{#hasMore}},{{/hasMore}}
        {{/isPrimitiveType}}
        {{^isPrimitiveType}}
        {{{baseName}}}List{{#hasMore}},{{/hasMore}}
        {{/isPrimitiveType}}
        {{/isListContainer}}
        {{#isMapContainer}}
        {{{complexType}}}List{{#hasMore}},{{/hasMore}}
        {{/isMapContainer}}
        {{/isContainer}}
        {{/vars}}
        );

    return {{classname}};
end:
    cJSON_Delete({{classname}}JSON);
    return NULL;

}
{{/isEnum}}
{{/model}}
{{/models}}
